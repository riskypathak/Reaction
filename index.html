<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Reaction Graph - POC</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/epoch.css">
    <link rel="stylesheet" href="css/iThing.css">
    <link rel="stylesheet" href="css/jquery-ui-1.8.10.custom.css">

    <script src="js/papaparse.js"></script>

    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
    <script src="js/jquery.mousewheel.min.js"></script>

    <script src="js/bootstrap.min.js"></script>
    <script src="js/jQAllRangeSliders-min.js"></script>
    <script src="js/jQAllRangeSliders-withRuler-min.js"></script>

    <script src="js/d3.js"></script>
    <script src="js/epoch.js"></script>

    <script type="text/javascript">
        var csvData;

        $(document).ready(function () {
            $("#csv-file").change(handleFileSelect);
        });

        function handleFileSelect(evt) {
            var file = evt.target.files[0];

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                complete: function (results) {
                    csvData = results;
                    process();
                }
            });
        }

        function process() {

            var dateKey = 'Latest Receive Date';
            var dateArray = csvData.data.map(function (item) {
                var date = item[dateKey].split('/');
                return new Date(date[2], date[1], date[0])

            });

            var maxT = new Date(Math.max.apply(null, dateArray));
            var minT = new Date(Math.min.apply(null, dateArray));

            $("#slider").dateRangeSlider({
                "bounds": {
                    min: minT,
                    max: maxT
                }
            });

            var history = [];

            history.push({ values: [] });

            var dictionary = [];

            for (i = 0; i < csvData.data.length; i++) {
                var key = csvData.data[i]["Reaction Description"];

                if (dictionary[key] == undefined) {
                    dictionary[key] = 1;
                }
                else {
                    dictionary[key] = dictionary[key] + 1;
                }
            }

            var table = document.getElementById("tblData");

            var keysSorted = Object.keys(dictionary).sort(function (a, b) { return dictionary[b] - dictionary[a] })

            for (i = 0; i < 20; i++) {
                var name = keysSorted[i];
                history[0].values.push({ x: name.length > 10 ? name.substr(0, 8).trim() + '..' : name, y: dictionary[name] });

                var row = table.insertRow(table.rows.length);
                var cell1 = row.insertCell(0);
                cell1.innerHTML = name;

                var cell2 = row.insertCell(1);
                cell2.innerHTML = dictionary[name];
            }

            $('#barChart').epoch({
                type: 'bar',
                axes: ['left', 'bottom'],
                data: history,
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h3 id="line">Select File</h3>
                <input type="file" id="csv-file" name="files" />
            </div>
            <div class="col-md-6">
                <div id="slider"></div>
            </div>
        </div>
        <div class="row">
            <h3 id="line">Data</h3>
            <div class="col-md-2">
                <table id="tblData">
                    <tr><th>Reaction</th><th>Cases</th></tr>
                </table>
            </div>
            <div class="col-md-10">
                <div id="barChart" class="epoch" style="height: 400px; width:1200px"></div>
            </div>
        </div>
    </div>
</body>
</html>
